version: 0.2

phases:
    pre_build:
        commands:
          - mvn clean install
          - echo Logging in to Amazon ECR...
          - aws --version
          - RESPOSITORY_URI=866087136701.dkr.ecr.ap-southeast-2.amazonaws.com/ecommerce-registry
          - aws ecr get-login-password --region ap-southeast-2 | docker login --username AWS --password-stdin $REPOSITORY_URI
          - commit_hash=$(echo $CODEBUILD_RESOLVED_SOURCE_VERSION | cut -c 1-7)
          - IMAGE_TAG=build-$(echo $CODEBUILD_BUILD_ID aws -F":" '{print $2}')
    build:
      commands:
        - echo Build started on `date`
        - echo Building the Docker image...
        - docker build -t $REPOSITORY_URI:latest .
        - docker tag $REPOSITORY_URI:latest $REPOSITORY_URI:$IMAGE_TAG
    post_build:
      commands:
        - echo Build completed on `date`
        - echo Pushing the Docker image...
        - docker push $REPOSITORY_URI:latest
        - docker push $REPOSITORY_URI:$IMAGE_TAG
        - echo Writing image definitions file...
        - printf '[{"name":"javabackend","imageUri":"%s"}]' $REPOSITORY_URI:$IMAGE_TAG > imagedefinitions.json
        - echo written image definitions file...
#       # add container name
        - DOCKER_CONTAINER_NAME=ecommerce-registry
        - echo "Container Name is $DOCKER_CONTAINER_NAME"
        - printf '[{"name":"%s","imageUri":"%s"}]' $DOCKER_CONTAINER_NAME $REPOSITORY_URI:$IMAGE_TAG > imagedefinitions.json
        - echo printing imagedefinitions.json
        - cat imagedefinitions.json

artifacts:
    files:
        - imagedefinitions.json
        - targets/*.jar
